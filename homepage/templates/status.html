{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" />
<div class="nav-background-behind"></div>
<div class="container-fruid whole_wrap">
    <div class="row">
        <div class="col-sm-7 quiz_wrap">
            <div class="d-flex flex-wrap justify-content-center align-items-start mx-3 my-4 p-3">
                {% for quiz in quizs %}
                <div class="my-1 quizBoxSelect" id="{{ loop.index }}">
                    <div class="col-10 card m-3" style="width: 13.5rem; height: 11rem; border-radius: 0.6rem;"
                        id="quizbox{{ loop.index }}">
                        {% if quiz.id in solved_quiz_ids %}
                        <div class="card-body text-quiz quizsuccess-top">
                            <h5 class="card-title fs-5 text fw-bold lh-base quizsuccess-text"
                                style="word-break:keep-all" id="quiz{{ quiz.id }}">{{ quiz.quiz }}</h5>
                            <p class="card-text"></p>
                        </div>
                        <div class="container card-footer quizsuccess">
                            <div class="row">
                                <span class="col-5 p-2 fs-6 fw-bold quizsuccess-number">No. {{ quiz.id }}</span>
                                <span class="col-7 text-end p-2 text-light fw-bold">
                                    {{ quiz.answer }}
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <div class="card-body text-quiz" id="quizCardBody{{ quiz.id }}">
                            <h5 class="card-title fs-5 text fw-bold lh-base" style="word-break: keep-all"
                                id="quiz{{ quiz.id }}">{{ quiz.quiz }}</h5>
                            <p class="card-text"></p>
                        </div>
                        <div class="container card-footer" id="unSolvedDiv{{ quiz.id }}">
                            <div class="row">
                                <span class="col-5 p-2 fs-6" id="unSolvedSpanQuizId{{ quiz.id }}">No. {{
                                    quiz.id}}</span>
                                <span class="col-7 text-end p-2 text-black-50" id="unSolvedSpan{{ quiz.id }}">
                                    ë„ì „ ê°€ëŠ¥
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-5">
            <div class="chat_wrap">
                <div class="inner">
                    <!-- ëŒ€í™” ì•„ì´í…œì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ê³µê°„ -->
                </div>
                <input type="text" class="mymsg h5 p-4 chatbotinput" placeholder="ë‚´ìš© ì…ë ¥ í›„ ì—”í„°ë¥¼ ëˆ„ë¥´ì„¸ìš”">
                <div class="text-center">
                    <p class="footer-text">ë¬¸ì œë¥¼&nbsp;í’€ê³ &nbsp;ì‹¶ë‹¤ë©´
                        <b class="fw-bold text-quiz">ë²ˆí˜¸ [1 ~ 120ë²ˆ]</b>ë¥¼&nbsp;&nbsp;/&nbsp;&nbsp;ì–´ë ¤ìš¸ ë•
                        <b class="fw-bold text-quiz">íŒíŠ¸</b> ìš”ì²­ì„&nbsp;&nbsp;/&nbsp;&nbsp;ë°°ê³ í”Œë•&nbsp;ìŒì‹ì„
                        <b class="fw-bold text-quiz">ì£¼ë¬¸</b>í•´ë³´ì„¸ìš”&nbsp;ğŸ‘
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed top-50 start-50 translate-middle-x">
    <div id="liveToast" class="toast align-items-center text-bg-warning border-0 toast-size-up" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastText">
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<script>

    // í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    document.addEventListener("DOMContentLoaded", function () {
        var mymsgInput = document.querySelector('.mymsg');
        var yourmsgInput = document.querySelector('.yourmsg');
        var chatInner = document.querySelector('.chat_wrap .inner');
        var elementBoxGlobal = null
        var elementTextGlobal = null
        var quiznumber = 0

        // XMLHttpRequest ê°ì²´ ìƒì„±
        var xhr = new XMLHttpRequest();

        mymsgInput.addEventListener('keypress', function (e) {

            if (e.keyCode === 13 && this.value.length && quiznumber > 0) {
                sendMessage(this.value, 'mymsg');

                xhr.open('POST', 'api/endpoint', true);                    // ìš”ì²­ì„ ë³´ë‚¼ ë©”ì„œë“œ ë° URL ì„¤ì •
                xhr.setRequestHeader('Content-Type', 'application/json');   // Content-Type í—¤ë” ì„¤ì • (JSON ì „ì†¡ ì‹œì—ëŠ” í•„ìš”)                             
                xhr.onload = function () {                                   // ìš”ì²­ ì™„ë£Œ ì‹œì˜ ì½œë°± í•¨ìˆ˜ ì„¤ì •

                    if (xhr.status === 200) {
                        var result = JSON.parse(xhr.responseText).result;
                        var resulttype = JSON.parse(xhr.responseText).resulttype;
                        var answer = JSON.parse(xhr.responseText).answer;
                        var solvedCount = JSON.parse(xhr.responseText).solvedCount;
                        if (resulttype == 'quiz') {
                            clearCheckBox()
                            sendMessageQuiz(result, 'yourmsg');
                            toScrollMoving(result);
                        } else if (resulttype == 'answer') {
                            clearCheckBox()
                            sendMessage(result, 'yourmsg');
                            changeDivSpan(quiznumber, answer);
                            addSolvedCountNumber();
                            if (solvedCount == 120) {
                                const toastLiveExample = document.getElementById('liveToast')
                                document.getElementById('toastText').innerHTML = 'ğŸŒˆ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ë¬¸ì œë¥¼ ë¬¸ì œ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ğŸŒˆ';
                                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
                                toastBootstrap.show()
                            } else if (solvedCount % 10 == 0) {
                                // alert('ğŸ‘ ì¶•í•˜í•©ë‹ˆë‹¤! ì´ ' + solvedCount + 'ë¬¸ì œ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ğŸ‘');
                                const toastLiveExample = document.getElementById('liveToast')
                                document.getElementById('toastText').innerHTML = 'ğŸ’ ì¶•í•˜í•©ë‹ˆë‹¤! ì´ ' + solvedCount + 'ë¬¸ì œ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤! ğŸ’';
                                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
                                toastBootstrap.show()
                            } else {
                            };
                            quiznumber = 0
                        } else if (resulttype == 'alreadySolved') {
                            sendMessage(result, 'yourmsg');
                            quiznumber = 0
                        } else {
                            sendMessage(result, 'yourmsg');
                        };

                    } else {
                        console.error('Request failed. Status:', xhr.status);
                    }
                };
                var data = { key: this.value, quiznumber: quiznumber };
                console.log(data);                                          // ì „ì†¡í•  ë°ì´í„°                                
                xhr.send(JSON.stringify(data));                             // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡

                this.value = '';
            }
            else if (e.keyCode === 13 && this.value.length) {
                sendMessage(this.value, 'mymsg');

                xhr.open('POST', 'api/endpoint', true);                    // ìš”ì²­ì„ ë³´ë‚¼ ë©”ì„œë“œ ë° URL ì„¤ì •
                xhr.setRequestHeader('Content-Type', 'application/json');  // Content-Type í—¤ë” ì„¤ì • (JSON ì „ì†¡ ì‹œì—ëŠ” í•„ìš”)                             
                xhr.onload = function () {                                 // ìš”ì²­ ì™„ë£Œ ì‹œì˜ ì½œë°± í•¨ìˆ˜ ì„¤ì •

                    if (xhr.status === 200) {
                        var result = JSON.parse(xhr.responseText).result;  // ì²˜ìŒì˜ result ê°’ì€ ë¬¸ì œ ë²ˆí˜¸ì„
                        var resulttype = JSON.parse(xhr.responseText).resulttype;
                        var answer = JSON.parse(xhr.responseText).answer;
                        var solvedCount = JSON.parse(xhr.responseText).solvedCount;
                        if (resulttype == 'quiz') {
                            clearCheckBox()
                            sendMessageQuiz(result, 'yourmsg');
                            toScrollMoving(result);
                        } else {
                            sendMessage(result, 'yourmsg');
                        };
                    } else {
                        console.error('Request failed. Status:', xhr.status);
                    }
                };
                var data = { key: this.value, quiznumber: quiznumber };            // ì „ì†¡í•  ë°ì´í„°                                
                xhr.send(JSON.stringify(data));         // ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡

                this.value = '';
            }
        });

        var currentTime = function () {
            var date = new Date();
            var hh = date.getHours();
            var mm = date.getMinutes();
            var apm = hh > 12 ? "ì˜¤í›„" : "ì˜¤ì „";
            var ct = apm + " " + hh + ":" + mm + "";
            return ct;
        };

        function sendMessage(message, className) {
            var newDiv = document.createElement('div');
            newDiv.className = 'item ' + className;
            newDiv.innerHTML = '<div class="box"><p class="msg h6">' + message + '</p><span class="time">' + currentTime() + '</span></div>';

            chatInner.appendChild(newDiv);

            var lastItem = chatInner.lastChild;
            setTimeout(function () {
                lastItem.classList.add("on");
            }, 10);

            var position = lastItem.offsetTop + chatInner.scrollTop;
            chatInner.scrollTop = position;
        }

        function sendMessageQuiz(result, className) {
            var newDiv = document.createElement('div');
            newDiv.className = 'item ' + className;
            const message = document.getElementById('quiz' + result).innerHTML;
            newDiv.innerHTML = '<div class="box"><p class="msg h6"><b class="fw-bold">Q' + result + '. '
                + message + '</b></p><span class="time">' + currentTime() + '</span></div>';

            chatInner.appendChild(newDiv);

            var lastItem = chatInner.lastChild;
            setTimeout(function () {
                lastItem.classList.add("on");
            }, 10);

            var position = lastItem.offsetTop + chatInner.scrollTop;
            chatInner.scrollTop = position;
        }

        function clearCheckBox() {
            if (elementBoxGlobal) {
                elementBoxGlobal.setAttribute('class', 'col-10 card m-3')
                elementTextGlobal.setAttribute('style', 'word-break:keep-all;')
            }
        }

        function toScrollMoving(result) {
            quiznumber = result;
            elementBox = document.getElementById('quizbox' + result);
            elementText = document.getElementById('quiz' + result);
            if (elementBox) {
                elementBox.scrollIntoView({ behavior: 'smooth', block: "center", inline: "center" })
                elementBox.setAttribute('class', 'col-10 card m-3 selected_quiz')
                elementText.setAttribute('style', 'word-break:keep-all; color:#916e07;')
            }
            elementBoxGlobal = elementBox
            elementTextGlobal = elementText
        }

        function changeDivSpan(quiznumber, answer) {
            unSolvedSpan = document.getElementById('unSolvedSpan' + quiznumber)
            unSolvedDiv = document.getElementById('unSolvedDiv' + quiznumber)
            unSolvedSpanQuizId = document.getElementById('unSolvedSpanQuizId' + quiznumber)
            quizCardBody = document.getElementById('quizCardBody' + quiznumber)
            quiz = document.getElementById('quiz' + quiznumber)
            score = document.getElementById('score' + quiznumber)
            unSolvedSpan.innerHTML = answer
            unSolvedSpan.setAttribute('class', 'col-7 text-end p-2 text-light fw-bold')
            unSolvedDiv.setAttribute('class', 'container card-footer quizsuccess')
            unSolvedSpanQuizId.setAttribute('class', 'col-5 p-2 fs-6 fw-bold quizsuccess-number')
            quizCardBody.setAttribute('class', 'card-body text-quiz quizsuccess-top')
            quiz.setAttribute('class', 'card-title fs-5 text fw-bold lh-base quizsuccess-text')
            score.setAttribute('class', 'circle-solved')
        }

        function addSolvedCountNumber() {
            solvedCountNumber = document.getElementById('solvedCountNumber').innerHTML;
            document.getElementById('solvedCountNumber').innerHTML = Number(solvedCountNumber) + 1;
        }

        var quizboxAll = document.querySelectorAll('.quizBoxSelect');

        quizboxAll.forEach(function (quizbox) {
            quizbox.addEventListener('click', function () {
                clearCheckBox();
                quiznumber = this.id;
                sendMessageQuiz(this.id, 'yourmsg');
                toScrollMoving(this.id);
            });
        });


        function goToFirstUnSolvedDiv() {
            // idê°€ 'unSolvedDiv*'ì¸ ëª¨ë“  div ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const unSolvedDivs = document.querySelectorAll("div[id^='unSolvedDiv']");

            // ê°€ì¥ ì‘ì€ idë¥¼ ê°€ì§„ div ìš”ì†Œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
            const firstUnSolvedDiv = unSolvedDivs[0];

            // ê°€ì¥ ì‘ì€ idë¥¼ ê°€ì§„ div ìš”ì†Œë¥¼ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤.
            firstUnSolvedDiv.scrollIntoView({ behavior: 'smooth', block: "center", inline: "center" })
        }

        sendMessage('<b class="fw-bold">{{ g.user.username }}</b>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!', 'yourmsg')
        sendMessage('<b class="fw-bold">ì•„ì¬í€´ì¦ˆ ë¬¸ì œ</b>ë¥¼ ì„ íƒí•˜ì„¸ìš”<br>[ ì…ë ¥ : 1 ~ 120ë²ˆ ]', 'yourmsg')
        sendMessage('<b class="fw-bold">Tip</b> : ë°°ê³ í”Œë• ìŒì‹ì„ <b class="fw-bold text-danger">"ì£¼ë¬¸"</b>í•´ë³´ì„¸ìš”ğŸœ', 'yourmsg')
        goToFirstUnSolvedDiv()

    });

</script>

{% endblock %}